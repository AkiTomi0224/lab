# 機関室図面 AI検出システム

機関室技術図面における機器の自動検出・位置特定を行う AI システムです。機械学習とコンピュータビジョンを活用して、複雑な技術図面から効率的に機器を識別・ハイライト表示します。

## 🚀 主要機能

### 🔍 AI-Based 機器検出
- **機械学習検出**: RandomForest分類器による高精度検出
- **最適化スライディングウィンドウ**: 30秒タイムアウトによる高速処理
- **マルチスケール検出**: 異なるサイズの機器に対応

### 📊 学習データ管理
- **インタラクティブ学習**: 図面上での直接アノテーション
- **バッチ処理**: 複数機器の同時学習
- **自動クリーンアップ**: 孤児レコードの自動削除
- **データ整合性**: 自動データ検証機能

### 🎯 高度な画像処理
- **Base64エンコーディング**: ブラウザからの直接画像処理
- **OpenCV統合**: 高度な画像解析機能
- **リアルタイム処理**: レスポンシブな検出結果表示

### 🛠️ エンタープライズ機能
- **SQLiteデータベース**: 軽量で高速なデータ管理
- **REST API**: 標準的なAPI設計
- **ログ管理**: 詳細な処理ログと進捗追跡
- **エラー処理**: 堅牢なエラー処理とリカバリ

## 📋 システム要件

### 前提条件
- Python 3.8以上
- 4GB以上のRAM（ML処理用）
- OpenCV対応環境

### 依存ライブラリ
```
Flask==2.3.3
opencv-python==4.8.1.78
scikit-learn==1.3.0
numpy==1.24.3
sqlite3 (標準ライブラリ)
```

## 🔧 セットアップ

### インストール

```bash
# プロジェクトディレクトリに移動
cd 図面可視化システム

# Python依存関係をインストール
pip install Flask opencv-python scikit-learn numpy

# macOS用 (OpenCV依存関係)
brew install poppler

# Ubuntu/Debian用
sudo apt-get install python3-opencv poppler-utils
```

### 実行

```bash
# バックエンドサーバーを起動 (Port: 8000)
cd backend
python app.py

# フロントエンドを開く
cd ../frontend
# ブラウザでindex.htmlを開く
open index.html
```

サーバーアクセス:
- **メインサーバー**: http://localhost:8000
- **ヘルスチェック**: http://localhost:8000/api/health

## 🏗️ システム構成

```
図面可視化システム/
├── backend/                    # Flask APIサーバー
│   ├── app.py                 # メインアプリケーション
│   ├── ml_enhanced_detector.py # 最適化ML検出エンジン
│   ├── enterprise_ml_system.py # エンタープライズML機能
│   ├── ml_training.py         # 学習システム
│   ├── advanced_matching.py   # 高度マッチングアルゴリズム
│   ├── auto_cleanup.py        # 自動クリーンアップシステム
│   ├── cleanup_orphaned_data.py # 孤児データクリーンアップ
│   ├── deep_cleanup.py        # 徹底クリーンアップ
│   ├── equipment.db           # SQLiteデータベース
│   └── trained_models/        # 学習済みMLモデル
├── frontend/                   # Webインターフェース
│   └── index.html             # メインUI
└── uploads/                   # 学習データストレージ
    └── training_sets_*/       # 機器別学習データ
```

## 🔧 API エンドポイント

### 検出機能
- `POST /api/simple-detect` - AI機器検出実行
- `GET /api/equipment` - 登録機器一覧取得
- `POST /api/equipment` - 新規機器登録

### 学習機能
- `POST /api/training-data` - 学習データ追加
- `POST /api/train-ml` - ML学習実行
- `DELETE /api/training-data/<id>` - 学習データ削除（自動クリーンアップ付き）

### 管理機能
- `GET /api/health` - システムヘルスチェック
- `GET /api/training-status` - 学習状況確認

## 📝 使用方法

### 1. 機器登録と学習データ作成
```
1. 機器名を入力
2. 機器画像をアップロード
3. 図面上で機器位置をクリック指定
4. 学習データとして保存
```

### 2. AI学習実行
```
1. 十分な学習データ（推奨：5個以上）を準備
2. "学習実行"ボタンをクリック
3. 学習完了を確認
```

### 3. 機器検出実行
```
1. 検出対象図面をアップロード
2. 検出したい機器を選択
3. "検出実行"ボタンをクリック
4. 結果をリアルタイムで確認
```

## ⚙️ 最適化機能

### 🔥 性能最適化
- **タイムアウト制御**: 30秒での処理完了保証
- **進捗ログ**: 100ウィンドウごとの進捗表示
- **メモリ効率**: 最適化されたスライディングウィンドウ
- **スケール削減**: 3スケール（0.7, 1.0, 1.3）での高速処理

### 🧹 自動メンテナンス
- **孤児レコード削除**: 参照切れデータの自動清理
- **学習モデル管理**: 不要モデルファイルの自動削除
- **データ整合性チェック**: 自動データ検証
- **Base64エラー修正**: フロントエンドエラーの自動修正

## 🛡️ エラー処理

### 自動修復機能
- **Base64データ修正**: 誤送信データの自動補正
- **パス解決**: 相対パス・絶対パスの自動解決
- **データベース修復**: スキーマエラーの自動修正
- **ファイル参照修復**: 欠損ファイルの自動検出・削除

### ログ出力
```bash
# リアルタイムログ確認
tail -f backend/enterprise_ml.log

# エラーログ確認
tail -f backend/server.log
```

## 🔍 トラブルシューティング

### 検出精度向上
1. **学習データ増加**: 機器あたり10個以上推奨
2. **多様な角度**: 異なる視点からの学習データ
3. **クリーンデータ**: 孤児レコードの定期削除

### パフォーマンス向上
1. **画像サイズ最適化**: 1500x1500以下推奨
2. **定期クリーンアップ**: `auto_cleanup.py`実行
3. **データベース最適化**: `deep_cleanup.py`実行

## 📊 システム統計

- **検出速度**: 30秒以内保証
- **精度**: 機器により70-95%
- **対応画像**: PNG, JPG, Base64
- **同時処理**: 複数機器対応
- **ストレージ効率**: 自動クリーンアップによる最適化

---

## 🔄 バージョン情報

**最新版**: 2025年9月版
- ML検出のハンギング問題解決
- 自動クリーンアップシステム導入
- Base64処理最適化
- ファイル構成整理完了

システムに関する質問や問題がある場合は、ログファイルを確認するか、詳細なエラーメッセージを提供してください。